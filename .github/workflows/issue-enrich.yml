name: Issue Enrichment from X

on:
  issues:
    types: [opened]

jobs:
  enrich-description:
    if: contains(github.event.issue.labels.*.name, 'ai-task')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Enrich issue description
        env:
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          GITHUB_OWNER: ${{ github.repository_owner }}
        run: |
          CLEAN_TITLE=$(echo "$ISSUE_TITLE" | sed 's/^\[.*\] //')

          PROMPT="ã‚ãªãŸã¯ã‚·ãƒ‹ã‚¢ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢å…¼ãƒ†ãƒƒã‚¯ãƒªã‚µãƒ¼ãƒãƒ£ãƒ¼ã§ã™ã€‚
          GitHub Issueã®ã‚¿ã‚¤ãƒˆãƒ«ã«åŸºã¥ã„ã¦ã€å®Ÿè£…ã«å¿…è¦ãªæƒ…å ±ã‚’ãƒªã‚µãƒ¼ãƒã—ã€
          å……å®Ÿã—ãŸIssueæœ¬æ–‡ã‚’è‡ªå‹•ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          ## å¯¾è±¡Issue
          - Issueç•ªå·: #${ISSUE_NUMBER}
          - ã‚¿ã‚¤ãƒˆãƒ«: ${CLEAN_TITLE}
          - ç¾åœ¨ã®æœ¬æ–‡ã¯ç’°å¢ƒå¤‰æ•° ISSUE_BODY ã«æ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ï¼ˆecho \"\$ISSUE_BODY\" ã§ç¢ºèªå¯èƒ½ï¼‰

          ## ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
          - Next.js / TypeScript ã§Webã‚¢ãƒ—ãƒªé–‹ç™º
          - AI/LLM ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€è‡ªå‹•åŒ–ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹ç¯‰
          - GitHub Actions + Claude Code ã«ã‚ˆã‚‹è‡ªå¾‹å®Ÿè£…
          - GCP (Cloud Run) ã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤é‹ç”¨
          - Zustand, Tailwind CSS, shadcn/ui

          ## æŒ‡ç¤º
          1. Issueã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰å®Ÿè£…ãƒ†ãƒ¼ãƒã‚’æ­£ç¢ºã«ç†è§£ã™ã‚‹
          2. ã‚ãªãŸã®æŠ€è¡“çŸ¥è­˜ã‚’æ´»ç”¨ã—ã€æœ€æ–°ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚„é–¢é€£æŠ€è¡“ã‚’èª¿æŸ»ã™ã‚‹
          3. WebFetchãŒä½¿ãˆã‚‹å ´åˆã¯ã€é–¢é€£ã™ã‚‹å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚„ãƒ–ãƒ­ã‚°è¨˜äº‹ã‚’å‚ç…§ã™ã‚‹
          4. ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§Issueæœ¬æ–‡ã‚’ç”Ÿæˆã™ã‚‹
          5. æ—¢å­˜ã®æœ¬æ–‡ã«ã‚ã‚‹ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆ<!-- target-repo: ... --> ç­‰ï¼‰ã¯å¿…ãšå…ˆé ­ã«ä¿æŒã™ã‚‹
          6. gh ã‚³ãƒãƒ³ãƒ‰ã§Issueæœ¬æ–‡ã‚’æ›´æ–°ã™ã‚‹:
             gh issue edit ${ISSUE_NUMBER} --repo ${GITHUB_OWNER}/sam-todo-agent --body \"\$GENERATED_BODY\"

          ## ç”Ÿæˆã™ã‚‹Issueæœ¬æ–‡ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

          \`\`\`
          ï¼ˆæ—¢å­˜ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ã“ã“ã«ä¿æŒï¼‰

          ## æ¦‚è¦
          å®Ÿè£…å†…å®¹ã®èª¬æ˜ï¼ˆ2-3æ–‡ã§ç°¡æ½”ã«ï¼‰

          ## èƒŒæ™¯ãƒ»ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³
          ãªãœã“ã®æ©Ÿèƒ½/ä¿®æ­£ãŒå¿…è¦ã‹ï¼ˆ1-2æ–‡ï¼‰

          ## å®Ÿè£…è¦ä»¶
          - [ ] è¦ä»¶1ï¼ˆå…·ä½“çš„ã§å®Ÿè£…å¯èƒ½ãªç²’åº¦ï¼‰
          - [ ] è¦ä»¶2
          - [ ] è¦ä»¶3

          ## æŠ€è¡“çš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
          - æ¨å¥¨ã™ã‚‹å®Ÿè£…æ–¹é‡
          - ä½¿ç”¨ã™ã¹ããƒ©ã‚¤ãƒ–ãƒ©ãƒª/API
          - æ³¨æ„ç‚¹ã‚„ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

          ## å‚è€ƒæƒ…å ±
          - é–¢é€£ã™ã‚‹å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆURL
          - é¡ä¼¼ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚„å‚è€ƒè¨˜äº‹
          \`\`\`

          ## é‡è¦
          - æ—¥æœ¬èªã§å‡ºåŠ›ã—ã¦ãã ã•ã„
          - Issueæœ¬æ–‡ã®æ›´æ–°ã«ã¯å¿…ãš gh issue edit ã‚’ä½¿ã£ã¦ãã ã•ã„
          - è³ªå•ã›ãšè‡ªåˆ†ã§åˆ¤æ–­ã—ã¦å®Œäº†ã•ã›ã¦ãã ã•ã„
          - å®Ÿè£…è€…ï¼ˆAIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼‰ãŒè¿·ã‚ãšç€æ‰‹ã§ãã‚‹å…·ä½“æ€§ã‚’æŒãŸã›ã¦ãã ã•ã„"

          set +e
          claude -p --dangerously-skip-permissions --output-format json --max-turns 15 "$PROMPT" \
            > /tmp/claude-output.json
          CLAUDE_EXIT=$?
          set -e

          echo "::group::Claude Output (exit code: $CLAUDE_EXIT)"
          cat /tmp/claude-output.json 2>/dev/null || echo "(no output file)"
          echo "::endgroup::"

      - name: Comment on enrichment
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: 'sam-todo-agent',
              issue_number: ${{ github.event.issue.number }},
              body: 'ğŸ” æŠ€è¡“ãƒªã‚µãƒ¼ãƒã«åŸºã¥ãIssueèª¬æ˜ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã—ãŸã€‚å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
            });
