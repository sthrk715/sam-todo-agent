name: Issue Enrichment from X

on:
  issues:
    types: [opened]

jobs:
  enrich-description:
    if: contains(github.event.issue.labels.*.name, 'ai-task')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Enrich issue with X content
        env:
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
          GH_TOKEN: ${{ github.token }}
          X_BEARER_TOKEN: ${{ secrets.X_BEARER_TOKEN }}
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          GITHUB_OWNER: ${{ github.repository_owner }}
        run: |
          CLEAN_TITLE=$(echo "$ISSUE_TITLE" | sed 's/^\[.*\] //')

          PROMPT="ã‚ãªãŸã¯ãƒªã‚µãƒ¼ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚
          GitHub Issueã®ã‚¿ã‚¤ãƒˆãƒ«ã«åŸºã¥ã„ã¦X (Twitter) ä¸Šã®é–¢é€£æŠ•ç¨¿ã‚„è¨˜äº‹ã‚’èª¿æŸ»ã—ã€
          Issueæœ¬æ–‡ã‚’è‡ªå‹•ç”Ÿæˆãƒ»æ›´æ–°ã—ã¦ãã ã•ã„ã€‚

          ## å¯¾è±¡Issue
          - Issueç•ªå·: #${ISSUE_NUMBER}
          - ã‚¿ã‚¤ãƒˆãƒ«: ${CLEAN_TITLE}
          - ç¾åœ¨ã®æœ¬æ–‡ã¯ç’°å¢ƒå¤‰æ•° ISSUE_BODY ã«æ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ï¼ˆecho \"\$ISSUE_BODY\" ã§ç¢ºèªå¯èƒ½ï¼‰

          ## ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæ¤œç´¢ã®æ–¹å‘æ€§ã«ä½¿ã£ã¦ãã ã•ã„ï¼‰
          - Next.js / TypeScript ã§Webã‚¢ãƒ—ãƒªé–‹ç™º
          - AI/LLM ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€è‡ªå‹•åŒ–ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹ç¯‰ã«é–¢å¿ƒ
          - GitHub Actions + Claude Code ã«ã‚ˆã‚‹è‡ªå¾‹å®Ÿè£…
          - GCP (Cloud Run) ã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤é‹ç”¨
          - é–¢å¿ƒåˆ†é‡: AI, Webé–‹ç™º, DevOps, è‡ªå‹•åŒ–, APIé€£æº

          ## X API ã®ä½¿ã„æ–¹
          Bearer TokenãŒç’°å¢ƒå¤‰æ•° X_BEARER_TOKEN ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚

          ### ãƒ„ã‚¤ãƒ¼ãƒˆæ¤œç´¢
          curl -s 'https://api.twitter.com/2/tweets/search/recent?query=KEYWORDS&max_results=10&tweet.fields=author_id,created_at,text,public_metrics&expansions=author_id&user.fields=username,name' \\
            -H \"Authorization: Bearer \$X_BEARER_TOKEN\"

          æ¤œç´¢ã®ã‚³ãƒ„:
          - ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³æŠ½å‡ºã—ã¦æ¤œç´¢
          - æ—¥æœ¬èªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨è‹±èªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ä¸¡æ–¹ã§æ¤œç´¢
          - çµæœãŒå°‘ãªã‘ã‚Œã°ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’åºƒã’ã¦å†æ¤œç´¢
          - lang:ja ã§æ—¥æœ¬èªæŠ•ç¨¿ã‚’å„ªå…ˆçš„ã«å–å¾—

          ### 403ã‚¨ãƒ©ãƒ¼ãŒè¿”ã‚‹å ´åˆ
          Free planã§ã¯search APIãŒä½¿ãˆã¾ã›ã‚“ã€‚ãã®å ´åˆã¯:
          1. ã‚ãªãŸã®çŸ¥è­˜ã‚’ãƒ™ãƒ¼ã‚¹ã«é–¢é€£æŠ€è¡“ã®æƒ…å ±ã‚’ã¾ã¨ã‚ã‚‹
          2. ã€ŒX APIæ¤œç´¢ã¯æœªå¯¾å¿œãƒ—ãƒ©ãƒ³ã€ã¨è¨˜è¼‰ã™ã‚‹

          ## æŒ‡ç¤º
          1. Issueã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰å®Ÿè£…ãƒ†ãƒ¼ãƒã‚’ç†è§£ã™ã‚‹
          2. X APIã§é–¢é€£æŠ•ç¨¿ã‚’æ¤œç´¢ã—ã€æœ‰ç›Šãªæƒ…å ±ã‚’åé›†ã™ã‚‹
          3. åé›†ã—ãŸæƒ…å ±ã‚’å…ƒã«ã€ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§Issueæœ¬æ–‡ã‚’ç”Ÿæˆã™ã‚‹
          4. æ—¢å­˜ã®æœ¬æ–‡ã«ã‚ã‚‹ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆ<!-- target-repo: ... --> ç­‰ï¼‰ã¯å¿…ãšå…ˆé ­ã«ä¿æŒã™ã‚‹
          5. gh ã‚³ãƒãƒ³ãƒ‰ã§Issueæœ¬æ–‡ã‚’æ›´æ–°ã™ã‚‹:
             gh issue edit ${ISSUE_NUMBER} --repo ${GITHUB_OWNER}/sam-todo-agent --body \"\$GENERATED_BODY\"

          ## ç”Ÿæˆã™ã‚‹Issueæœ¬æ–‡ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

          \`\`\`
          ï¼ˆæ—¢å­˜ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ã“ã“ã«ä¿æŒï¼‰

          ## æ¦‚è¦
          Issueã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰æ¨æ¸¬ã•ã‚Œã‚‹å®Ÿè£…å†…å®¹ã®èª¬æ˜ï¼ˆ2-3æ–‡ï¼‰

          ## Xä¸Šã®é–¢é€£æƒ…å ±
          | æŠ•ç¨¿è€… | å†…å®¹ã®è¦ç´„ | å‚è€ƒãƒã‚¤ãƒ³ãƒˆ |
          |--------|-----------|-------------|
          | [@user](url) | æŠ•ç¨¿è¦ç´„ | ã“ã®Issueã«æ´»ã‹ã›ã‚‹ç‚¹ |

          ï¼ˆæ¤œç´¢ã§ããªã‹ã£ãŸå ´åˆã¯ç†ç”±ã‚’è¨˜è¼‰ï¼‰

          ## å®Ÿè£…è¦ä»¶
          - [ ] è¦ä»¶1ï¼ˆXæŠ•ç¨¿ã‚’å‚è€ƒã«ã—ãŸå…·ä½“çš„è¦ä»¶ï¼‰
          - [ ] è¦ä»¶2
          - [ ] è¦ä»¶3

          ## æŠ€è¡“ãƒ¡ãƒ¢
          - æ¨å¥¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª/API
          - æ³¨æ„ç‚¹ã‚„ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
          - å‚è€ƒãƒªãƒ³ã‚¯
          \`\`\`

          ## é‡è¦
          - æ—¥æœ¬èªã§å‡ºåŠ›ã—ã¦ãã ã•ã„
          - Issueæœ¬æ–‡ã®æ›´æ–°ã«ã¯å¿…ãš gh issue edit ã‚’ä½¿ã£ã¦ãã ã•ã„
          - è³ªå•ã›ãšè‡ªåˆ†ã§åˆ¤æ–­ã—ã¦å®Œäº†ã•ã›ã¦ãã ã•ã„"

          set +e
          claude -p --dangerously-skip-permissions --output-format json --max-turns 15 "$PROMPT" \
            > /tmp/claude-output.json
          CLAUDE_EXIT=$?
          set -e

          echo "::group::Claude Output (exit code: $CLAUDE_EXIT)"
          cat /tmp/claude-output.json 2>/dev/null || echo "(no output file)"
          echo "::endgroup::"

      - name: Comment on enrichment
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: 'sam-todo-agent',
              issue_number: ${{ github.event.issue.number }},
              body: 'ğŸ” Xä¸Šã®é–¢é€£æƒ…å ±ã‚’èª¿æŸ»ã—ã€Issueèª¬æ˜ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã—ãŸã€‚å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
            });
