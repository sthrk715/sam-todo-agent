name: Claude AI Agent

on:
  issues:
    types: [labeled]

jobs:
  claude-agent:
    if: github.event.label.name == 'ai-implement'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    env:
      ISSUE_NUMBER: ${{ github.event.issue.number }}
    steps:
      # 1. Issueæœ¬æ–‡ã‹ã‚‰å¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒ‘ãƒ¼ã‚¹
      - name: Parse target repo
        id: parse
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          TARGET=$(echo "$ISSUE_BODY" | grep -oP '<!-- target-repo: \K\S+(?= -->)' || echo "sam-todo-agent")
          echo "target_repo=$TARGET" >> "$GITHUB_OUTPUT"
          echo "Target repository: $TARGET"

      # 2. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ©ãƒ™ãƒ«ã‚’ç¢ºä¿ & in-progress ã«è¨­å®š
      - name: Set status in-progress
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const owner = context.repo.owner;
            const repo = 'sam-todo-agent';
            const issue_number = ${{ github.event.issue.number }};
            const labels = [
              { name: 'status:in-progress', color: 'fbca04', description: 'AIå®Ÿè£…ä¸­' },
              { name: 'status:review', color: '0075ca', description: 'PRãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡' },
              { name: 'status:failed', color: 'e11d48', description: 'å®Ÿè£…å¤±æ•—' },
            ];
            for (const l of labels) {
              try { await github.rest.issues.createLabel({ owner, repo, ...l }); } catch {}
            }
            try { await github.rest.issues.removeLabel({ owner, repo, issue_number, name: 'ai-implement' }); } catch {}
            try { await github.rest.issues.removeLabel({ owner, repo, issue_number, name: 'status:failed' }); } catch {}
            try { await github.rest.issues.removeLabel({ owner, repo, issue_number, name: 'status:review' }); } catch {}
            await github.rest.issues.addLabels({ owner, repo, issue_number, labels: ['status:in-progress'] });

      # 3. å¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/${{ steps.parse.outputs.target_repo }}
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      # 4. Claude Code ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      # 5. ãƒ–ãƒ©ãƒ³ãƒä½œæˆï¼ˆå†å®Ÿè¡Œæ™‚ã¯æ—¢å­˜ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒªã‚»ãƒƒãƒˆï¼‰
      - name: Create branch
        run: |
          BRANCH="ai/issue-${ISSUE_NUMBER}"
          git fetch origin "$BRANCH" 2>/dev/null && git checkout "$BRANCH" && git reset --hard origin/main || git checkout -b "$BRANCH"
          echo "BRANCH=$BRANCH" >> "$GITHUB_ENV"

      # 6. Claude ã§å®Ÿè£…
      - name: Implement with Claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
        run: |
          echo "::group::Debug Info"
          echo "ANTHROPIC_API_KEY set: $([ -n "$ANTHROPIC_API_KEY" ] && echo 'YES' || echo 'NO')"
          echo "Claude version: $(claude --version 2>&1 || echo 'NOT FOUND')"
          echo "Issue #${ISSUE_NUMBER}"
          echo "Working directory: $(pwd)"
          ls -la
          echo "::endgroup::"

          # å®Ÿè¡Œé–‹å§‹æ™‚åˆ»ã‚’è¨˜éŒ²ï¼ˆAdmin APIã‚³ã‚¹ãƒˆå–å¾—ç”¨ï¼‰
          START_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "CLAUDE_START_TIME=$START_TIME" >> "$GITHUB_ENV"

          CLEAN_TITLE=$(echo "$ISSUE_TITLE" | sed 's/^\[.*\] //')
          CLEAN_BODY=$(echo "$ISSUE_BODY" | sed 's/<!-- target-repo: [^ ]* -->//')

          PROMPT="ã‚ãªãŸã¯ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®Issueã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚
          è³ªå•ã›ãšã«è‡ªåˆ†ã§åˆ¤æ–­ã—ã¦å®Ÿè£…ã‚’å®Œäº†ã•ã›ã¦ãã ã•ã„ã€‚

          ## Issue #${ISSUE_NUMBER}
          ã‚¿ã‚¤ãƒˆãƒ«: ${CLEAN_TITLE}
          æœ¬æ–‡: ${CLEAN_BODY}

          ## æŒ‡ç¤º
          - ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’åˆ†æã—ã€Issueã®å†…å®¹ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„
          - å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆãƒ»ä¿®æ­£ã—ã¦ãã ã•ã„
          - ä¸æ˜ç‚¹ãŒã‚ã£ã¦ã‚‚æ¨æ¸¬ã—ã¦å®Ÿè£…ã‚’é€²ã‚ã¦ãã ã•ã„
          - Issueæœ¬æ–‡ã«ã€ŒXä¸Šã®é–¢é€£æƒ…å ±ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆã€ãã“ã«è¨˜è¼‰ã•ã‚ŒãŸ
            æŠ•ç¨¿ã‚„æŠ€è¡“æƒ…å ±ã‚’å‚è€ƒã«ã—ã¦å®Ÿè£…æ–¹é‡ã‚’æ±ºå®šã—ã¦ãã ã•ã„
          - Issueæœ¬æ–‡ã®ã€Œå®Ÿè£…è¦ä»¶ã€ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆãŒã‚ã‚‹å ´åˆã€ãã‚Œã‚’æº€ãŸã™ã‚ˆã†ã«å®Ÿè£…ã—ã¦ãã ã•ã„

          ## åˆ©ç”¨å¯èƒ½ãªAPI
          X (Twitter) APIã®èªè¨¼æƒ…å ±ãŒç’°å¢ƒå¤‰æ•°ã§åˆ©ç”¨å¯èƒ½ã§ã™:
          - X_API_KEY, X_API_SECRET (API Key / Secret)
          - X_ACCESS_TOKEN, X_ACCESS_SECRET (Access Token / Secret)
          X/Twitteré€£æºæ©Ÿèƒ½ã®å®Ÿè£…ã‚„ã€ãƒã‚¹ãƒˆæŠ•ç¨¿ãŒå¿…è¦ãªå ´åˆã«ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
          OAuth 1.0a (HMAC-SHA1) ã§èªè¨¼ã—ã€X API v2 ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

          ## æœ€å¾Œã®å‡ºåŠ›
          å®Ÿè£…ãŒå®Œäº†ã—ãŸã‚‰ã€æœ€å¾Œã«ä»¥ä¸‹ã®å½¢å¼ã§å®Ÿè£…å†…å®¹ã®ã‚µãƒãƒªã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„:
          ---IMPL_SUMMARY_START---
          ã“ã“ã«å®Ÿè£…å†…å®¹ã®è¦ç´„ã‚’æ—¥æœ¬èªã§è¨˜è¿°ï¼ˆ3-5è¡Œç¨‹åº¦ï¼‰
          ---IMPL_SUMMARY_END---"

          echo "::group::Prompt"
          echo "$PROMPT"
          echo "::endgroup::"

          set +e
          claude -p --dangerously-skip-permissions --output-format json --max-turns 30 "$PROMPT" \
            > /tmp/claude-output.json
          CLAUDE_EXIT=$?
          set -e

          echo "::group::Claude Output (exit code: $CLAUDE_EXIT)"
          cat /tmp/claude-output.json 2>/dev/null || echo "(no output file)"
          echo "::endgroup::"

          if [ "$CLAUDE_EXIT" -ne 0 ]; then
            echo "::warning::Claude Code exited with code $CLAUDE_EXIT"
          fi

          # å‡ºåŠ›ã‹ã‚‰å®Ÿè£…ã‚µãƒãƒªã‚’æŠ½å‡º
          if [ -f /tmp/claude-output.json ]; then
            IMPL_DESC=$(cat /tmp/claude-output.json | jq -r '.result // .content // ""' 2>/dev/null | \
              sed -n '/---IMPL_SUMMARY_START---/,/---IMPL_SUMMARY_END---/p' | \
              grep -v '---IMPL_SUMMARY' || echo "")
            if [ -n "$IMPL_DESC" ]; then
              # Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦ä¿å­˜
              IMPL_DESC_B64=$(echo "$IMPL_DESC" | base64 -w 0 2>/dev/null || echo "$IMPL_DESC" | base64)
              echo "IMPL_DESCRIPTION=$IMPL_DESC_B64" >> "$GITHUB_ENV"
              echo "::group::Implementation Summary"
              echo "$IMPL_DESC"
              echo "::endgroup::"
            fi
          fi

      # 6.5. Admin APIã§ã‚³ã‚¹ãƒˆå–å¾—
      - name: Get cost from Admin API
        env:
          ANTHROPIC_ADMIN_KEY: ${{ secrets.ANTHROPIC_ADMIN_KEY }}
        run: |
          END_TIME=$(date -u -d "+2 minutes" +"%Y-%m-%dT%H:%M:%SZ" 2>/dev/null || date -u -v+2M +"%Y-%m-%dT%H:%M:%SZ")
          echo "Cost query: ${CLAUDE_START_TIME} to ${END_TIME}"

          COST_RESPONSE=$(curl -s \
            "https://api.anthropic.com/v1/organizations/cost_report?starting_at=${CLAUDE_START_TIME}&ending_at=${END_TIME}&bucket_width=1d&group_by[]=description" \
            -H "x-api-key: $ANTHROPIC_ADMIN_KEY" \
            -H "anthropic-version: 2023-06-01")

          echo "::group::Admin API Cost Response"
          echo "$COST_RESPONSE" | jq . 2>/dev/null || echo "$COST_RESPONSE"
          echo "::endgroup::"

          TOTAL_CENTS=$(echo "$COST_RESPONSE" | jq -r '
            [.data[]?.results[]?.amount // "0" | tonumber] | add // 0
          ' 2>/dev/null || echo "0")

          if [ "$TOTAL_CENTS" != "0" ] && [ -n "$TOTAL_CENTS" ]; then
            COST=$(echo "scale=4; $TOTAL_CENTS / 100" | bc)
            echo "API_COST=$COST" >> "$GITHUB_ENV"
            echo "Total cost: \$${COST} (${TOTAL_CENTS} cents)"
          else
            echo "API_COST=unknown" >> "$GITHUB_ENV"
            echo "::warning::Could not retrieve cost from Admin API"
          fi

      # 7. ã‚³ãƒŸãƒƒãƒˆ & ãƒ—ãƒƒã‚·ãƒ¥ + å¤‰æ›´ã‚µãƒãƒªå–å¾—
      - name: Commit and push
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes detected"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          git commit -m "feat: implement sam-todo-agent#${ISSUE_NUMBER}"

          # å¤‰æ›´ã‚µãƒãƒªã‚’å–å¾—ï¼ˆGITHUB_ENVã«ä¿å­˜ï¼‰
          DIFF_STAT=$(git diff --stat HEAD~1 HEAD | tail -1)
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | tr '\n' ',')
          echo "DIFF_STAT=${DIFF_STAT}" >> "$GITHUB_ENV"
          echo "CHANGED_FILES=${CHANGED_FILES%,}" >> "$GITHUB_ENV"

          git push --force-with-lease origin "$BRANCH"
          echo "has_changes=true" >> "$GITHUB_OUTPUT"

      # 8. PRä½œæˆ
      - name: Create PR
        if: steps.commit.outputs.has_changes == 'true'
        id: pr
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          TARGET_REPO: ${{ steps.parse.outputs.target_repo }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          CLEAN_TITLE=$(echo "$ISSUE_TITLE" | sed 's/^\[.*\] //')
          OWNER="${{ github.repository_owner }}"

          # æ—¢å­˜PRãƒã‚§ãƒƒã‚¯
          EXISTING_PR=$(gh pr list --repo "${OWNER}/${TARGET_REPO}" --head "$BRANCH" --json url --jq '.[0].url' 2>/dev/null || echo "")
          if [ -n "$EXISTING_PR" ]; then
            echo "PR already exists: $EXISTING_PR"
            echo "pr_url=${EXISTING_PR}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # PRæœ¬æ–‡ã‚’å¤‰æ•°ã§æ§‹ç¯‰ï¼ˆheredocã®å•é¡Œã‚’å›é¿ï¼‰
          PR_BODY="Implements ${OWNER}/sam-todo-agent#${ISSUE_NUMBER}

          ${DIFF_STAT}

          Closes ${OWNER}/sam-todo-agent#${ISSUE_NUMBER}"

          echo "::group::Creating PR"
          echo "Repo: ${OWNER}/${TARGET_REPO}"
          echo "Head: $BRANCH"
          echo "Base: main"
          echo "Title: ${CLEAN_TITLE}"
          echo "::endgroup::"

          PR_URL=$(gh pr create \
            --repo "${OWNER}/${TARGET_REPO}" \
            --head "$BRANCH" \
            --base main \
            --title "${CLEAN_TITLE}" \
            --body "$PR_BODY" 2>&1)
          PR_EXIT=$?

          if [ $PR_EXIT -ne 0 ]; then
            echo "::error::PR creation failed (exit $PR_EXIT): $PR_URL"
            # gh api ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            PR_URL=$(gh api "repos/${OWNER}/${TARGET_REPO}/pulls" \
              -f head="$BRANCH" -f base="main" \
              -f title="${CLEAN_TITLE}" -f body="$PR_BODY" \
              --jq '.html_url' 2>&1) || echo "::error::Fallback also failed: $PR_URL"
          fi

          echo "PR URL: $PR_URL"
          echo "pr_url=${PR_URL}" >> "$GITHUB_OUTPUT"

      # 9. å®Ÿè£…è©³ç´°ã‚’Issue bodyã«è¨˜éŒ²ï¼ˆã‚³ã‚¹ãƒˆãƒ»PR URLãƒ»å¤‰æ›´ã‚µãƒãƒªï¼‰
      - name: Record implementation details
        if: steps.commit.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const owner = context.repo.owner;
            const repo = 'sam-todo-agent';
            const issue_number = ${{ github.event.issue.number }};
            const cost = process.env.API_COST || '';
            const prUrl = '${{ steps.pr.outputs.pr_url }}' || '';
            const diffStat = process.env.DIFF_STAT || '';
            const changedFiles = process.env.CHANGED_FILES || '';
            const implDescription = process.env.IMPL_DESCRIPTION || '';

            const { data: issue } = await github.rest.issues.get({ owner, repo, issue_number });
            let body = issue.body || '';

            // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–° or è¿½åŠ 
            const meta = {
              'api-cost': cost,
              'pr-url': prUrl,
              'impl-summary': diffStat,
              'impl-files': changedFiles,
              'impl-description': implDescription,
            };
            for (const [key, value] of Object.entries(meta)) {
              if (!value || value === 'unknown') continue;
              const regex = new RegExp(`<!-- ${key}: .+? -->`);
              const tag = `<!-- ${key}: ${value} -->`;
              if (body.match(regex)) {
                body = body.replace(regex, tag);
              } else {
                body = `${tag}\n${body}`;
              }
            }

            await github.rest.issues.update({ owner, repo, issue_number, body });

      # 10. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°
      - name: Set status review
        if: steps.commit.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const owner = context.repo.owner;
            const repo = 'sam-todo-agent';
            const issue_number = ${{ github.event.issue.number }};
            try { await github.rest.issues.removeLabel({ owner, repo, issue_number, name: 'status:in-progress' }); } catch {}
            await github.rest.issues.addLabels({ owner, repo, issue_number, labels: ['status:review'] });

      - name: Set status failed
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const owner = context.repo.owner;
            const repo = 'sam-todo-agent';
            const issue_number = ${{ github.event.issue.number }};
            try { await github.rest.issues.removeLabel({ owner, repo, issue_number, name: 'status:in-progress' }); } catch {}
            await github.rest.issues.addLabels({ owner, repo, issue_number, labels: ['status:failed'] });

      # 11. å…ƒIssueã«ã‚³ãƒ¡ãƒ³ãƒˆ
      - name: Comment on issue
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const hasChanges = '${{ steps.commit.outputs.has_changes }}' === 'true';
            const targetRepo = '${{ steps.parse.outputs.target_repo }}';
            const prUrl = '${{ steps.pr.outputs.pr_url }}' || '';
            const cost = process.env.API_COST || 'unknown';
            const costText = cost !== 'unknown' ? `\nAPI ã‚³ã‚¹ãƒˆ: $${cost}` : '';
            const diffStat = process.env.DIFF_STAT || '';
            const summaryText = diffStat ? `\nå¤‰æ›´: ${diffStat}` : '';
            let message;
            if (hasChanges && prUrl) {
              message = `ğŸ¤– å®Ÿè£…å®Œäº†ï¼PRã‚’ä½œæˆã—ã¾ã—ãŸã€‚\n\nå¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒª: \`${targetRepo}\`\nPR: ${prUrl}${summaryText}${costText}`;
            } else if (hasChanges) {
              message = `ğŸ¤– å®Ÿè£…å®Œäº†ï¼\n\nå¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒª: \`${targetRepo}\`${summaryText}${costText}`;
            } else {
              message = `ğŸ¤– å¤‰æ›´å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚Issueã®å†…å®¹ã‚’ã‚ˆã‚Šå…·ä½“çš„ã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚${costText}`;
            }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: 'sam-todo-agent',
              issue_number: ${{ github.event.issue.number }},
              body: message
            });
