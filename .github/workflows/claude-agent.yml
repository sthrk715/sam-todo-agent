name: Claude AI Agent

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

jobs:
  claude-agent:
    if: |
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'ai-task')) ||
      (github.event_name == 'issue_comment' && contains(github.event.issue.labels.*.name, 'ai-task'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    env:
      ISSUE_NUMBER: ${{ github.event.issue.number }}
    steps:
      # 1. Issueæœ¬æ–‡ã‹ã‚‰å¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒ‘ãƒ¼ã‚¹
      - name: Parse target repo
        id: parse
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          TARGET=$(echo "$ISSUE_BODY" | grep -oP '<!-- target-repo: \K\S+(?= -->)' || echo "sam-todo-agent")
          echo "target_repo=$TARGET" >> "$GITHUB_OUTPUT"
          echo "Target repository: $TARGET"

      # 2. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ©ãƒ™ãƒ«ã‚’ç¢ºä¿ & in-progress ã«è¨­å®š
      - name: Set status in-progress
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = 'sam-todo-agent';
            const issue_number = ${{ github.event.issue.number }};
            const labels = [
              { name: 'status:in-progress', color: 'fbca04', description: 'AIå®Ÿè£…ä¸­' },
              { name: 'status:review', color: '0075ca', description: 'PRãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡' },
              { name: 'status:failed', color: 'e11d48', description: 'å®Ÿè£…å¤±æ•—' },
            ];
            for (const l of labels) {
              try { await github.rest.issues.createLabel({ owner, repo, ...l }); } catch {}
            }
            try { await github.rest.issues.removeLabel({ owner, repo, issue_number, name: 'status:failed' }); } catch {}
            try { await github.rest.issues.removeLabel({ owner, repo, issue_number, name: 'status:review' }); } catch {}
            await github.rest.issues.addLabels({ owner, repo, issue_number, labels: ['status:in-progress'] });

      # 3. å¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/${{ steps.parse.outputs.target_repo }}
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      # 4. Claude Code ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      # 5. ãƒ–ãƒ©ãƒ³ãƒä½œæˆï¼ˆå†å®Ÿè¡Œæ™‚ã¯æ—¢å­˜ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒªã‚»ãƒƒãƒˆï¼‰
      - name: Create branch
        run: |
          BRANCH="ai/issue-${ISSUE_NUMBER}"
          git fetch origin "$BRANCH" 2>/dev/null && git checkout "$BRANCH" && git reset --hard origin/main || git checkout -b "$BRANCH"
          echo "BRANCH=$BRANCH" >> "$GITHUB_ENV"

      # 6. Claude ã§å®Ÿè£…ï¼ˆã‚³ã‚¹ãƒˆæƒ…å ±ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ï¼‰
      - name: Implement with Claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          CLEAN_TITLE=$(echo "$ISSUE_TITLE" | sed 's/^\[.*\] //')
          CLEAN_BODY=$(echo "$ISSUE_BODY" | sed 's/<!-- target-repo: [^ ]* -->//')

          claude -p --dangerously-skip-permissions --output-format stream-json "$(cat <<EOF
          ã‚ãªãŸã¯ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®Issueã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚
          è³ªå•ã›ãšã«è‡ªåˆ†ã§åˆ¤æ–­ã—ã¦å®Ÿè£…ã‚’å®Œäº†ã•ã›ã¦ãã ã•ã„ã€‚

          ## Issue #${ISSUE_NUMBER}
          ã‚¿ã‚¤ãƒˆãƒ«: ${CLEAN_TITLE}
          æœ¬æ–‡: ${CLEAN_BODY}

          ## æŒ‡ç¤º
          - ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’åˆ†æã—ã€Issueã®å†…å®¹ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„
          - å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆãƒ»ä¿®æ­£ã—ã¦ãã ã•ã„
          - ä¸æ˜ç‚¹ãŒã‚ã£ã¦ã‚‚æ¨æ¸¬ã—ã¦å®Ÿè£…ã‚’é€²ã‚ã¦ãã ã•ã„
          EOF
          )" > /tmp/claude-output.jsonl 2>&1 || true

          # ã‚³ã‚¹ãƒˆæƒ…å ±ã‚’æŠ½å‡ºï¼ˆstream-json ã® result ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ï¼‰
          COST=$(cat /tmp/claude-output.jsonl | grep -oP '"cost_usd"\s*:\s*\K[\d.]+' | tail -1 || echo "")
          if [ -z "$COST" ]; then
            COST=$(cat /tmp/claude-output.jsonl | grep -oP '"total_cost"\s*:\s*\K[\d.]+' | tail -1 || echo "")
          fi
          echo "API_COST=${COST:-unknown}" >> "$GITHUB_ENV"
          echo "Extracted cost: ${COST:-unknown}"

      # 7. ã‚³ãƒŸãƒƒãƒˆ & ãƒ—ãƒƒã‚·ãƒ¥
      - name: Commit and push
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes detected"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          git commit -m "feat: implement sam-todo-agent#${ISSUE_NUMBER}"
          git push --force-with-lease origin "$BRANCH"
          echo "has_changes=true" >> "$GITHUB_OUTPUT"

      # 8. å¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒªã«PRä½œæˆ
      - name: Create PR
        if: steps.commit.outputs.has_changes == 'true'
        id: pr
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          TARGET_REPO: ${{ steps.parse.outputs.target_repo }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          CLEAN_TITLE=$(echo "$ISSUE_TITLE" | sed 's/^\[.*\] //')
          OWNER="${{ github.repository_owner }}"
          PR_URL=$(gh pr create \
            --repo "${OWNER}/${TARGET_REPO}" \
            --title "${CLEAN_TITLE}" \
            --body "$(cat <<'PRBODY'
          Implements ${{ github.repository_owner }}/sam-todo-agent#${{ github.event.issue.number }}

          Closes ${{ github.repository_owner }}/sam-todo-agent#${{ github.event.issue.number }}
          PRBODY
          )") || true
          echo "pr_url=${PR_URL}" >> "$GITHUB_OUTPUT"

      # 9. Issueã«ã‚³ã‚¹ãƒˆæƒ…å ±ã‚’åŸ‹ã‚è¾¼ã¿
      - name: Record cost in issue body
        if: env.API_COST != 'unknown'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = 'sam-todo-agent';
            const issue_number = ${{ github.event.issue.number }};
            const cost = process.env.API_COST;
            const { data: issue } = await github.rest.issues.get({ owner, repo, issue_number });
            let body = issue.body || '';
            // æ—¢å­˜ã®ã‚³ã‚¹ãƒˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–° or è¿½åŠ 
            if (body.includes('<!-- api-cost:')) {
              body = body.replace(/<!-- api-cost: [\d.]+ -->/, `<!-- api-cost: ${cost} -->`);
            } else {
              body = `<!-- api-cost: ${cost} -->\n${body}`;
            }
            await github.rest.issues.update({ owner, repo, issue_number, body });

      # 10. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°
      - name: Set status review
        if: steps.commit.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = 'sam-todo-agent';
            const issue_number = ${{ github.event.issue.number }};
            try { await github.rest.issues.removeLabel({ owner, repo, issue_number, name: 'status:in-progress' }); } catch {}
            await github.rest.issues.addLabels({ owner, repo, issue_number, labels: ['status:review'] });

      - name: Set status failed
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = 'sam-todo-agent';
            const issue_number = ${{ github.event.issue.number }};
            try { await github.rest.issues.removeLabel({ owner, repo, issue_number, name: 'status:in-progress' }); } catch {}
            await github.rest.issues.addLabels({ owner, repo, issue_number, labels: ['status:failed'] });

      # 11. å…ƒIssueã«ã‚³ãƒ¡ãƒ³ãƒˆ
      - name: Comment on issue
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const hasChanges = '${{ steps.commit.outputs.has_changes }}' === 'true';
            const targetRepo = '${{ steps.parse.outputs.target_repo }}';
            const prUrl = '${{ steps.pr.outputs.pr_url }}' || '';
            const cost = process.env.API_COST || 'unknown';
            const costText = cost !== 'unknown' ? `\nAPI ã‚³ã‚¹ãƒˆ: $${cost}` : '';
            let message;
            if (hasChanges && prUrl) {
              message = `ğŸ¤– å®Ÿè£…å®Œäº†ï¼PRã‚’ä½œæˆã—ã¾ã—ãŸã€‚\n\nå¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒª: \`${targetRepo}\`\nPR: ${prUrl}${costText}`;
            } else if (hasChanges) {
              message = `ğŸ¤– å®Ÿè£…å®Œäº†ï¼\n\nå¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒª: \`${targetRepo}\`${costText}`;
            } else {
              message = `ğŸ¤– å¤‰æ›´å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚Issueã®å†…å®¹ã‚’ã‚ˆã‚Šå…·ä½“çš„ã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚${costText}`;
            }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: 'sam-todo-agent',
              issue_number: ${{ github.event.issue.number }},
              body: message
            });
