name: Claude AI Agent

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

jobs:
  claude-agent:
    if: |
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'ai-task')) ||
      (github.event_name == 'issue_comment' && contains(github.event.issue.labels.*.name, 'ai-task'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    env:
      ISSUE_NUMBER: ${{ github.event.issue.number }}
    steps:
      # 1. Issueæœ¬æ–‡ã‹ã‚‰å¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒ‘ãƒ¼ã‚¹
      - name: Parse target repo
        id: parse
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          TARGET=$(echo "$ISSUE_BODY" | grep -oP '<!-- target-repo: \K\S+(?= -->)' || echo "sam-todo-agent")
          echo "target_repo=$TARGET" >> "$GITHUB_OUTPUT"
          echo "Target repository: $TARGET"

      # 2. å¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/${{ steps.parse.outputs.target_repo }}
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      # 3. Claude Code ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      # 4. ãƒ–ãƒ©ãƒ³ãƒä½œæˆï¼ˆå†å®Ÿè¡Œæ™‚ã¯æ—¢å­˜ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒªã‚»ãƒƒãƒˆï¼‰
      - name: Create branch
        run: |
          BRANCH="ai/issue-${ISSUE_NUMBER}"
          git fetch origin "$BRANCH" 2>/dev/null && git checkout "$BRANCH" && git reset --hard origin/main || git checkout -b "$BRANCH"
          echo "BRANCH=$BRANCH" >> "$GITHUB_ENV"

      # 5. Claude ã§å®Ÿè£…
      - name: Implement with Claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          CLEAN_TITLE=$(echo "$ISSUE_TITLE" | sed 's/^\[.*\] //')
          CLEAN_BODY=$(echo "$ISSUE_BODY" | sed 's/<!-- target-repo: [^ ]* -->//')

          claude -p --dangerously-skip-permissions "$(cat <<EOF
          ã‚ãªãŸã¯ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®Issueã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚
          è³ªå•ã›ãšã«è‡ªåˆ†ã§åˆ¤æ–­ã—ã¦å®Ÿè£…ã‚’å®Œäº†ã•ã›ã¦ãã ã•ã„ã€‚

          ## Issue #${ISSUE_NUMBER}
          ã‚¿ã‚¤ãƒˆãƒ«: ${CLEAN_TITLE}
          æœ¬æ–‡: ${CLEAN_BODY}

          ## æŒ‡ç¤º
          - ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’åˆ†æã—ã€Issueã®å†…å®¹ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„
          - å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆãƒ»ä¿®æ­£ã—ã¦ãã ã•ã„
          - ä¸æ˜ç‚¹ãŒã‚ã£ã¦ã‚‚æ¨æ¸¬ã—ã¦å®Ÿè£…ã‚’é€²ã‚ã¦ãã ã•ã„
          EOF
          )"

      # 6. ã‚³ãƒŸãƒƒãƒˆ & ãƒ—ãƒƒã‚·ãƒ¥
      - name: Commit and push
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes detected"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          git commit -m "feat: implement sam-todo-agent#${ISSUE_NUMBER}"
          git push --force-with-lease origin "$BRANCH"
          echo "has_changes=true" >> "$GITHUB_OUTPUT"

      # 7. å¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒªã«PRä½œæˆ
      - name: Create PR
        if: steps.commit.outputs.has_changes == 'true'
        id: pr
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          TARGET_REPO: ${{ steps.parse.outputs.target_repo }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          CLEAN_TITLE=$(echo "$ISSUE_TITLE" | sed 's/^\[.*\] //')
          OWNER="${{ github.repository_owner }}"
          PR_URL=$(gh pr create \
            --repo "${OWNER}/${TARGET_REPO}" \
            --title "${CLEAN_TITLE}" \
            --body "$(cat <<'PRBODY'
          Implements ${{ github.repository_owner }}/sam-todo-agent#${{ github.event.issue.number }}

          Closes ${{ github.repository_owner }}/sam-todo-agent#${{ github.event.issue.number }}
          PRBODY
          )")
          echo "pr_url=$PR_URL" >> "$GITHUB_OUTPUT"

      # 8. å…ƒIssueã«ã‚³ãƒ¡ãƒ³ãƒˆ
      - name: Comment on issue
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const hasChanges = '${{ steps.commit.outputs.has_changes }}' === 'true';
            const targetRepo = '${{ steps.parse.outputs.target_repo }}';
            const prUrl = '${{ steps.pr.outputs.pr_url }}' || '';
            let message;
            if (hasChanges && prUrl) {
              message = `ğŸ¤– å®Ÿè£…å®Œäº†ï¼PRã‚’ä½œæˆã—ã¾ã—ãŸã€‚\n\nå¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒª: \`${targetRepo}\`\nPR: ${prUrl}`;
            } else if (hasChanges) {
              message = `ğŸ¤– å®Ÿè£…å®Œäº†ï¼\n\nå¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒª: \`${targetRepo}\``;
            } else {
              message = `ğŸ¤– å¤‰æ›´å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚Issueã®å†…å®¹ã‚’ã‚ˆã‚Šå…·ä½“çš„ã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚`;
            }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: 'sam-todo-agent',
              issue_number: ${{ github.event.issue.number }},
              body: message
            });
